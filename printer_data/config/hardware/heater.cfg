###########################
# Heater Settings - OPTIMIZED
# 230V, 750W Bed Heater
# 24v, 50W Hot-end Heater
###########################

#####################################################################
#   Bed Heater - Optimized for Fast Heating & Stability
#####################################################################

[heater_bed]
heater_pin: PA3
sensor_type: Generic 3950
sensor_pin: PF3

# PID Control (bereits gut kalibriert)
control: pid
pid_Kp: 37.653
pid_Ki: 1.050
pid_Kd: 337.466

# Power Settings - OPTIMIERT
max_power: 0.75                # Erhöht von 0.6 auf 0.75 (562W) für schnelleres Aufheizen
                               # Immer noch sicher, aber 25% schneller
min_temp: 0
max_temp: 120

# PWM Settings für sanftere Regelung
pwm_cycle_time: 0.0166         # 60Hz (optimal für 230V AC über SSR)
                               # Reduziert Temperatur-Overshoot

#####################################################################
#   Verify Heater - Erweiterte Sicherheit & Fehlertoleranz
#####################################################################

[verify_heater heater_bed]
max_error: 120                 # Standard: 120
                               # Erlaubt größere Temperaturabweichung vor Fehler
check_gain_time: 90            # Erhöht von 60 auf 90 Sekunden
                               # 230V Betten brauchen länger zum Stabilisieren
heating_gain: 2                # Mindestens 2°C in check_gain_time
                               # Verhindert false-positive Fehler bei hohen Temps
hysteresis: 5                  # ±5°C Toleranz
                               # Verhindert Fehler bei kleinen Schwankungen

#####################################################################
#   Bed Fans (optional - für schnelleres Abkühlen)
#####################################################################

# Uncomment if you want bed cooling after prints
# [fan_generic bed_cooling_fan]
# pin: YOUR_PIN
# max_power: 1.0
# shutdown_speed: 0
# kick_start_time: 0.5

#####################################################################
#   Heater Macro Optimizations
#####################################################################

[gcode_macro M190]
rename_existing: M190.1
description: Bed heating with progress feedback
gcode:
    {% set s = params.S|default(0)|float %}
    {% set current = printer.heater_bed.temperature %}

    {% if s > 0 %}
        RESPOND MSG="Heating bed to {s}°C (current: {current}°C)"

        # Full power heating für schnellstes Aufheizen
        SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={s}

        # LED Feedback während Aufheizen
        STATUS_HEATING

        # Wait mit Progress-Updates
        {% if s > current + 5 %}
            RESPOND MSG="Bed heating... ETA ~{((s - current) / 2)|int} minutes"
        {% endif %}

        TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s}

        # Kurze Stabilisierungszeit
        {% if s >= 100 %}
            RESPOND MSG="Stabilizing bed temperature..."
            G4 P30000  # 30 Sekunden für ABS/ASA
        {% else %}
            G4 P10000  # 10 Sekunden für PLA/PETG
        {% endif %}

        RESPOND MSG="Bed ready at {s}°C"
        STATUS_READY
    {% else %}
        SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=0
    {% endif %}

[gcode_macro BED_PREHEAT]
description: Intelligentes Bed Preheating für Material
gcode:
    {% set material = params.MATERIAL|default("PLA")|upper %}
    {% set temps = {
        "PLA": 60,
        "PLA+": 65,
        "PETG": 80,
        "ABS": 105,
        "ASA": 105,
        "TPU": 50
    } %}

    {% set target = temps[material]|default(60) %}

    RESPOND MSG="Preheating bed for {material} ({target}°C)"
    M190 S{target}

[gcode_macro BED_COOLDOWN]
description: Schnelles Bed Abkühlen
gcode:
    {% set target = params.TARGET|default(40)|int %}

    RESPOND MSG="Cooling bed to {target}°C"
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=0

    # Bed Fans on (wenn verfügbar)
    # SET_FAN_SPEED FAN=BedFans SPEED=1.0

    # Warte bis Zieltemperatur erreicht
    TEMPERATURE_WAIT SENSOR=heater_bed MAXIMUM={target}

    # Bed Fans off
    # SET_FAN_SPEED FAN=BedFans SPEED=0

    RESPOND MSG="Bed cooled to {target}°C"

#####################################################################
#   Extruder (unverändert)
#####################################################################

[extruder]
pressure_advance: 0.045
pressure_advance_smooth_time: 0.040
step_pin: PE2
dir_pin: PE3
enable_pin: !PD4
rotation_distance: 22.4284412
gear_ratio: 50:10
microsteps: 32
full_steps_per_rotation: 200
nozzle_diameter: 0.400
filament_diameter: 1.75

max_extrude_only_distance: 1400.0
max_extrude_only_velocity: 120
max_extrude_only_accel: 3000
max_extrude_cross_section: 5

heater_pin: PA2
sensor_type: PT1000
sensor_pin: PF4
min_temp: 10
max_temp: 300
max_power: 1.0
min_extrude_temp: 190
control: pid
pid_Kp: 23.226
pid_Ki: 1.421
pid_Kd: 94.934
