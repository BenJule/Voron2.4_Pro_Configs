#####################################################################
#   Motor Management Macros
#####################################################################

[gcode_macro MOTOR_STATUS]
description: Zeige Status aller Motoren
gcode:
    RESPOND MSG="=== Motor Status ==="
    RESPOND MSG="X/Y Motors: LDO 42STH48-2004MAH (1.4A)"
    RESPOND MSG="Z Motors:   LDO 42STH48-2004AC (1.0A)"
    RESPOND MSG="Extruder:   LDO 36STH20-1004AHG (0.6A)"
    RESPOND MSG="Mode: SpreadCycle (X/Y/E), StealthChop (Z)"
    RESPOND MSG="===================="

[gcode_macro MOTOR_CURRENT_INFO]
description: Zeige aktuelle Motorströme
gcode:
    {% set x_current = printer.configfile.settings['tmc2209 stepper_x'].run_current %}
    {% set y_current = printer.configfile.settings['tmc2209 stepper_y'].run_current %}
    {% set z_current = printer.configfile.settings['tmc2209 stepper_z'].run_current %}
    {% set e_current = printer.configfile.settings['tmc2209 extruder'].run_current %}

    RESPOND MSG="=== Motor Currents ==="
    RESPOND MSG="X: {x_current}A / 2.0A (70%)"
    RESPOND MSG="Y: {y_current}A / 2.0A (70%)"
    RESPOND MSG="Z: {z_current}A / 2.0A (50%)"
    RESPOND MSG="E: {e_current}A / 1.0A (60%)"
    RESPOND MSG="====================="

[gcode_macro SET_XY_CURRENT]
description: Ändere X/Y Motor Strom (für Tests)
gcode:
    {% set current = params.CURRENT|default(1.4)|float %}

    {% if current > 2.0 %}
        RESPOND MSG="ERROR: Maximum 2.0A für X/Y Motoren!"
    {% else %}
        SET_TMC_CURRENT STEPPER=stepper_x CURRENT={current}
        SET_TMC_CURRENT STEPPER=stepper_y CURRENT={current}
        RESPOND MSG="X/Y current set to {current}A"
    {% endif %}

[gcode_macro SET_Z_CURRENT]
description: Ändere Z Motor Strom
gcode:
    {% set current = params.CURRENT|default(1.0)|float %}

    {% if current > 2.0 %}
        RESPOND MSG="ERROR: Maximum 2.0A für Z Motoren!"
    {% else %}
        SET_TMC_CURRENT STEPPER=stepper_z CURRENT={current}
        SET_TMC_CURRENT STEPPER=stepper_z1 CURRENT={current}
        SET_TMC_CURRENT STEPPER=stepper_z2 CURRENT={current}
        SET_TMC_CURRENT STEPPER=stepper_z3 CURRENT={current}
        RESPOND MSG="Z current set to {current}A"
    {% endif %}

[gcode_macro SET_E_CURRENT]
description: Ändere Extruder Motor Strom
gcode:
    {% set current = params.CURRENT|default(0.6)|float %}

    {% if current > 1.0 %}
        RESPOND MSG="ERROR: Maximum 1.0A für Extruder Motor!"
    {% else %}
        SET_TMC_CURRENT STEPPER=extruder CURRENT={current}
        RESPOND MSG="Extruder current set to {current}A"
    {% endif %}

[gcode_macro XY_PERFORMANCE_MODE]
description: X/Y auf Maximum Performance (SpreadCycle only)
gcode:
    RESPOND MSG="Activating X/Y Performance Mode..."
    SET_TMC_FIELD STEPPER=stepper_x FIELD=en_spreadCycle VALUE=1
    SET_TMC_FIELD STEPPER=stepper_y FIELD=en_spreadCycle VALUE=1
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT=1.4
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT=1.4
    RESPOND MSG="Performance Mode: Active"
    RESPOND MSG="(Louder but maximum precision)"

[gcode_macro XY_BALANCED_MODE]
description: X/Y auf Balanced Mode (Hybrid)
gcode:
    RESPOND MSG="Activating X/Y Balanced Mode..."
    SET_TMC_FIELD STEPPER=stepper_x FIELD=stealthchop_threshold VALUE=100
    SET_TMC_FIELD STEPPER=stepper_y FIELD=stealthchop_threshold VALUE=100
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT=1.2
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT=1.2
    RESPOND MSG="Balanced Mode: Active"
    RESPOND MSG="(Silent at low speeds, powerful at high speeds)"

[gcode_macro XY_SILENT_MODE]
description: X/Y auf Silent Mode (StealthChop)
gcode:
    RESPOND MSG="Activating X/Y Silent Mode..."
    SET_TMC_FIELD STEPPER=stepper_x FIELD=stealthchop_threshold VALUE=999999
    SET_TMC_FIELD STEPPER=stepper_y FIELD=stealthchop_threshold VALUE=999999
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT=1.0
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT=1.0
    RESPOND MSG="Silent Mode: Active"
    RESPOND MSG="(Quieter but less torque)"

[gcode_macro MOTOR_TEMP_CHECK]
description: Überprüfe Motor Temperaturen (manuell)
gcode:
    RESPOND MSG="=== Motor Temperature Check ==="
    RESPOND MSG="Bitte überprüfe manuell:"
    RESPOND MSG="1. Öffne Druckergehäuse"
    RESPOND MSG="2. Fühle X/Y Motoren (sollten warm sein)"
    RESPOND MSG="3. Optimal: 40-60°C"
    RESPOND MSG="4. Zu heiß (>80°C): Strom reduzieren"
    RESPOND MSG="5. Kalt: Alles OK"
    RESPOND MSG="==============================="

[gcode_macro MOTOR_DIAGNOSTICS]
description: Zeige detaillierte Motor Diagnostik
gcode:
    RESPOND MSG="=== Motor Diagnostics ==="
    DUMP_TMC STEPPER=stepper_x
    RESPOND MSG="---"
    DUMP_TMC STEPPER=stepper_y
    RESPOND MSG="---"
    DUMP_TMC STEPPER=stepper_z
    RESPOND MSG="---"
    DUMP_TMC STEPPER=extruder
    RESPOND MSG="========================"

[gcode_macro MOTOR_VIBRATION_TEST]
description: Teste Motor Vibrationen
gcode:
    RESPOND MSG="=== Motor Vibration Test ==="
    RESPOND MSG="Testing X axis..."

    G28
    G90
    G0 X50 F6000
    G0 X300 F12000
    G0 X50 F12000
    G0 X175 F6000

    RESPOND MSG="Testing Y axis..."
    G0 Y50 F6000
    G0 Y300 F12000
    G0 Y50 F12000
    G0 Y175 F6000

    RESPOND MSG="Test complete!"
    RESPOND MSG="Listen for unusual sounds or vibrations"
    RESPOND MSG="============================"

[gcode_macro MOTOR_RESET_TO_DEFAULTS]
description: Setze Motor Einstellungen auf optimierte Defaults zurück
gcode:
    RESPOND MSG="Resetting motors to optimized defaults..."
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT=1.4
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT=1.4
    SET_TMC_CURRENT STEPPER=stepper_z CURRENT=1.0
    SET_TMC_CURRENT STEPPER=stepper_z1 CURRENT=1.0
    SET_TMC_CURRENT STEPPER=stepper_z2 CURRENT=1.0
    SET_TMC_CURRENT STEPPER=stepper_z3 CURRENT=1.0
    SET_TMC_CURRENT STEPPER=extruder CURRENT=0.6
    RESPOND MSG="Motors reset to default settings"

#####################################################################
#   Advanced Motor Tuning
#####################################################################

[gcode_macro TUNE_XY_MOTORS]
description: Interaktives X/Y Motor Tuning
gcode:
    RESPOND MSG="=== X/Y Motor Tuning ==="
    RESPOND MSG="1. Start with current: 1.4A"
    RESPOND MSG="2. Run test prints"
    RESPOND MSG="3. Check for layer shifts or skipping"
    RESPOND MSG="4. If OK: Done!"
    RESPOND MSG="5. If shifts: Increase to 1.5A"
    RESPOND MSG="6. If too hot: Decrease to 1.3A"
    RESPOND MSG="========================"

[gcode_macro MOTOR_BREAK_IN]
description: Motor Einlaufprozess (für neue Motoren)
gcode:
    RESPOND MSG="=== Motor Break-In Procedure ==="
    RESPOND MSG="Running motors at 80% for break-in..."

    SET_TMC_CURRENT STEPPER=stepper_x CURRENT=1.6
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT=1.6

    G28
    G90

    {% for i in range(10) %}
        RESPOND MSG="Break-in cycle {i+1}/10"
        G0 X50 Y50 F6000
        G0 X300 Y300 F12000
        G0 X50 Y300 F12000
        G0 X300 Y50 F12000
    {% endfor %}

    RESPOND MSG="Break-in complete!"
    RESPOND MSG="Resetting to normal current..."
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT=1.4
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT=1.4

#####################################################################
#   Emergency Motor Controls
#####################################################################

[gcode_macro EMERGENCY_MOTOR_OFF]
description: Notfall - Alle Motoren ausschalten
gcode:
    M84
    RESPOND MSG="!!! ALL MOTORS DISABLED !!!"

[gcode_macro REDUCE_MOTOR_CURRENT]
description: Reduziere alle Motorströme um 20% (bei Überhitzung)
gcode:
    {% set x_current = printer.configfile.settings['tmc2209 stepper_x'].run_current * 0.8 %}
    {% set y_current = printer.configfile.settings['tmc2209 stepper_y'].run_current * 0.8 %}
    {% set z_current = printer.configfile.settings['tmc2209 stepper_z'].run_current * 0.8 %}
    {% set e_current = printer.configfile.settings['tmc2209 extruder'].run_current * 0.8 %}

    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={x_current}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={y_current}
    SET_TMC_CURRENT STEPPER=stepper_z CURRENT={z_current}
    SET_TMC_CURRENT STEPPER=stepper_z1 CURRENT={z_current}
    SET_TMC_CURRENT STEPPER=stepper_z2 CURRENT={z_current}
    SET_TMC_CURRENT STEPPER=stepper_z3 CURRENT={z_current}
    SET_TMC_CURRENT STEPPER=extruder CURRENT={e_current}

    RESPOND MSG="Motor currents reduced by 20%"
    RESPOND MSG="X/Y: {x_current}A, Z: {z_current}A, E: {e_current}A"
