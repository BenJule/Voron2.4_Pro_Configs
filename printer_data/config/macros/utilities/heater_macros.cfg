#####################################################################
#   Heater Optimization Macros
#####################################################################

[gcode_macro BED_PREHEAT]
description: Intelligentes Bed Preheating
gcode:
    {% set material = params.MATERIAL|default("PLA")|upper %}
    {% set temps = {
        "PLA": 60,
        "PLA+": 65,
        "PETG": 80,
        "ABS": 105,
        "ASA": 105,
        "TPU": 50
    } %}
    {% set target = temps[material]|default(60) %}

    RESPOND MSG="Preheating bed for {material} to {target}C"
    STATUS_HEATING
    M140 S{target}
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={target}

    {% if target >= 100 %}
        RESPOND MSG="Stabilizing high temp bed (30s)..."
        G4 P30000
    {% else %}
        RESPOND MSG="Stabilizing bed (10s)..."
        G4 P10000
    {% endif %}

    STATUS_READY
    RESPOND MSG="Bed ready at {target}C"

[gcode_macro BED_COOLDOWN]
description: Schnelles Bed Abkühlen
gcode:
    {% set target = params.TARGET|default(40)|int %}

    RESPOND MSG="Cooling bed to {target}C"
    M140 S0

    SET_FAN_SPEED FAN=BedFans SPEED=1.0

    TEMPERATURE_WAIT SENSOR=heater_bed MAXIMUM={target}

    SET_FAN_SPEED FAN=BedFans SPEED=0

    RESPOND MSG="Bed cooled to {target}C"

[gcode_macro BED_PID_TUNE]
description: PID Tuning für Heizbett
gcode:
    {% set target = params.TARGET|default(105)|int %}

    RESPOND MSG="Starting PID tuning for bed at {target}C"
    RESPOND MSG="This will take ~15 minutes..."

    STATUS_HEATING

    PID_CALIBRATE HEATER=heater_bed TARGET={target}

    RESPOND MSG="PID tuning complete! Run SAVE_CONFIG to save."
    STATUS_READY

[gcode_macro BED_STATUS]
description: Zeige Bed Heater Status
gcode:
    {% set bed = printer.heater_bed %}
    RESPOND MSG="=== Bed Heater Status ==="
    RESPOND MSG="Temperature: {bed.temperature}C"
    RESPOND MSG="Target: {bed.target}C"
    RESPOND MSG="Power: {(bed.power * 100)|round(1)}%"
    RESPOND MSG="========================"

[gcode_macro BED_HEAT_TEST]
description: Teste Bed Heating Performance
gcode:
    {% set target = params.TARGET|default(105)|int %}

    RESPOND MSG="=== Bed Heating Performance Test ==="
    RESPOND MSG="Target: {target}C"

    {% set start_temp = printer.heater_bed.temperature %}
    {% set start_time = printer.system_stats.cputime %}

    RESPOND MSG="Starting temp: {start_temp}C"
    RESPOND MSG="Starting heating..."

    M140 S{target}
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={target}

    {% set end_time = printer.system_stats.cputime %}
    {% set duration = (end_time - start_time)|int %}
    {% set temp_gain = target - start_temp %}
    {% set rate = (temp_gain / duration * 60)|round(1) %}

    RESPOND MSG="=== Results ==="
    RESPOND MSG="Time: {duration}s ({(duration/60)|round(1)}min)"
    RESPOND MSG="Temp gain: {temp_gain}C"
    RESPOND MSG="Heating rate: {rate}C/min"
    RESPOND MSG="==============="

    M140 S0
