#####################################################################
#   Motor Test Macros (ohne Heizen)
#####################################################################

[gcode_macro MOTOR_TEST_COLD]
description: Teste alle Motoren ohne zu heizen
gcode:
    {% if printer.toolhead.homed_axes != "xyz" %}
        RESPOND MSG="Homing all axes first..."
        G28
    {% endif %}

    RESPOND MSG="=== Motor Test Started ==="
    RESPOND MSG="Testing motors at current temperature"
    RESPOND MSG="X/Y: 0.8A, Z: 1.0A, E: 0.5A"

    G90  # Absolute positioning

    # Test X axis
    RESPOND MSG="Testing X axis..."
    G0 X50 F6000
    G4 P500
    G0 X300 F12000
    G4 P500
    G0 X50 F12000
    G4 P500
    G0 X175 F6000

    # Test Y axis
    RESPOND MSG="Testing Y axis..."
    G0 Y50 F6000
    G4 P500
    G0 Y300 F12000
    G4 P500
    G0 Y50 F12000
    G4 P500
    G0 Y175 F6000

    # Test Z axis
    RESPOND MSG="Testing Z axis (slow)..."
    G0 Z50 F1200
    G4 P1000
    G0 Z150 F1200
    G4 P1000
    G0 Z50 F1200

    # Park position
    G0 X175 Y175 Z100 F9000

    RESPOND MSG="=== Motor Test Complete ==="
    RESPOND MSG="Check for:"
    RESPOND MSG="- Unusual sounds"
    RESPOND MSG="- Skipped steps"
    RESPOND MSG="- Vibrations"
    RESPOND MSG="- Motor temperature (should be <60C)"

[gcode_macro MOTOR_TEST_XY_ONLY]
description: Teste nur X/Y Achsen (schnell)
gcode:
    {% if printer.toolhead.homed_axes != "xyz" %}
        RESPOND MSG="Homing all axes first..."
        G28
    {% endif %}

    RESPOND MSG="=== X/Y Motor Test ==="
    G90

    # Diagonal movements
    RESPOND MSG="Testing diagonal movements..."
    G0 X50 Y50 F6000
    G0 X300 Y300 F15000
    G0 X50 Y300 F15000
    G0 X300 Y50 F15000
    G0 X175 Y175 F9000

    # Fast back and forth X
    RESPOND MSG="Testing X rapid movements..."
    {% for i in range(5) %}
        G0 X50 F18000
        G0 X300 F18000
    {% endfor %}
    G0 X175 F6000

    # Fast back and forth Y
    RESPOND MSG="Testing Y rapid movements..."
    {% for i in range(5) %}
        G0 Y50 F18000
        G0 Y300 F18000
    {% endfor %}
    G0 Y175 F6000

    # Circle pattern
    RESPOND MSG="Testing circular motion..."
    G0 X175 Y175 F9000
    {% for i in range(8) %}
        {% set angle = i * 45 %}
        {% set x = 175 + 100 * (angle|float / 57.3)|cos %}
        {% set y = 175 + 100 * (angle|float / 57.3)|sin %}
        G0 X{x} Y{y} F12000
    {% endfor %}
    G0 X175 Y175 F9000

    RESPOND MSG="=== X/Y Test Complete ==="

[gcode_macro MOTOR_TEST_Z_ONLY]
description: Teste nur Z Achsen (QGL Test)
gcode:
    {% if printer.toolhead.homed_axes != "xyz" %}
        RESPOND MSG="Homing all axes first..."
        G28
    {% endif %}

    RESPOND MSG="=== Z Motor Test ==="
    RESPOND MSG="Testing all 4 Z motors at 1.0A"

    G90

    # Move to center
    G0 X175 Y175 F9000

    # Z movement test
    RESPOND MSG="Testing Z up/down movements..."
    {% for i in range(3) %}
        G0 Z20 F1200
        G4 P500
        G0 Z200 F1200
        G4 P500
    {% endfor %}

    G0 Z100 F1200

    RESPOND MSG="Testing slow Z precision..."
    G0 Z100.5 F300
    G0 Z100.0 F300
    G0 Z99.5 F300
    G0 Z100.0 F300

    RESPOND MSG="=== Z Test Complete ==="
    RESPOND MSG="If no errors, Z motors are OK at 1.0A"

[gcode_macro MOTOR_TEMP_CHECK]
description: Überprüfe Motor Temperaturen (manuell)
gcode:
    RESPOND MSG="=== Motor Temperature Check ==="
    RESPOND MSG="Please manually check motor temperatures:"
    RESPOND MSG=""
    RESPOND MSG="1. Stop any print/movement"
    RESPOND MSG="2. Wait 30 seconds for motors to stabilize"
    RESPOND MSG="3. Carefully touch each motor:"
    RESPOND MSG="   - X Motor (Left rear)"
    RESPOND MSG="   - Y Motor (Right rear)"
    RESPOND MSG="   - Z Motors (4x corners)"
    RESPOND MSG="   - Extruder Motor"
    RESPOND MSG=""
    RESPOND MSG="Temperature Guide:"
    RESPOND MSG="  < 40°C: Excellent (can hold comfortably)"
    RESPOND MSG="  40-50°C: Good (warm to touch)"
    RESPOND MSG="  50-60°C: Acceptable (hot but safe)"
    RESPOND MSG="  60-70°C: Warning (very hot)"
    RESPOND MSG="  > 70°C: TOO HOT! Reduce current!"
    RESPOND MSG=""
    RESPOND MSG="Current settings:"
    RESPOND MSG="  X/Y: 0.8A (should be 40-50°C)"
    RESPOND MSG="  Z:   1.0A (should be 40-55°C)"
    RESPOND MSG="  E:   0.5A (should be <40°C)"

[gcode_macro MOTOR_CURRENT_TEST]
description: Teste verschiedene Motorströme (X/Y)
gcode:
    RESPOND MSG="=== Motor Current Test ==="
    RESPOND MSG="WARNING: This will test different currents"
    RESPOND MSG="Monitor motor temperatures!"

    {% if printer.toolhead.homed_axes != "xyz" %}
        G28
    {% endif %}

    G90
    G0 X175 Y175 Z100 F9000

    # Test at 0.8A (current safe value)
    RESPOND MSG="Testing at 0.8A (current setting)..."
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT=0.8
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT=0.8
    G0 X50 Y50 F6000
    G0 X300 Y300 F15000
    G0 X175 Y175 F9000
    G4 P5000  # Wait 5 seconds

    # Test at 0.9A
    RESPOND MSG="Testing at 0.9A..."
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT=0.9
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT=0.9
    G0 X50 Y50 F6000
    G0 X300 Y300 F15000
    G0 X175 Y175 F9000
    G4 P5000

    # Test at 1.0A
    RESPOND MSG="Testing at 1.0A..."
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT=1.0
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT=1.0
    G0 X50 Y50 F6000
    G0 X300 Y300 F15000
    G0 X175 Y175 F9000
    G4 P5000

    # Reset to safe 0.8A
    RESPOND MSG="Resetting to safe 0.8A..."
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT=0.8
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT=0.8

    RESPOND MSG="=== Current Test Complete ==="
    RESPOND MSG="Check motor temperatures now!"
    RESPOND MSG="Wait 2-3 minutes and check again"
