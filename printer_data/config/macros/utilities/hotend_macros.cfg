#####################################################################
#   Dragon HF Hotend Optimization Macros
#####################################################################

[gcode_macro HOTEND_PREHEAT]
description: Intelligentes Hotend Preheating
gcode:
    {% set material = params.MATERIAL|default("PLA")|upper %}
    {% set temps = {
        "PLA": 210,
        "PLA+": 220,
        "PETG": 240,
        "ABS": 245,
        "ASA": 250,
        "TPU": 230
    } %}
    {% set target = temps[material]|default(210) %}

    RESPOND MSG="Preheating hotend for {material} to {target}C"
    STATUS_HEATING
    M104 S{target}

    {% if target >= 240 %}
        RESPOND MSG="High temp material detected"
    {% endif %}

[gcode_macro HOTEND_PID_TUNE]
description: PID Tuning für Dragon HF Hotend
gcode:
    {% set target = params.TARGET|default(230)|int %}

    RESPOND MSG="Starting PID tuning for Dragon HF at {target}C"
    RESPOND MSG="This will take ~5 minutes..."

    STATUS_HEATING

    PID_CALIBRATE HEATER=extruder TARGET={target}

    RESPOND MSG="PID tuning complete! Run SAVE_CONFIG to save."
    STATUS_READY

[gcode_macro HOTEND_STATUS]
description: Zeige Hotend Status
gcode:
    {% set e = printer.extruder %}
    RESPOND MSG="=== Dragon HF Hotend Status ==="
    RESPOND MSG="Temperature: {e.temperature}C"
    RESPOND MSG="Target: {e.target}C"
    RESPOND MSG="Power: {(e.power * 100)|round(1)}%"
    RESPOND MSG="Pressure Advance: {e.pressure_advance}"
    RESPOND MSG="=============================="

[gcode_macro HOTEND_HEAT_TEST]
description: Teste Hotend Heating Performance
gcode:
    {% set target = params.TARGET|default(230)|int %}

    RESPOND MSG="=== Dragon HF Heating Test ==="
    RESPOND MSG="Target: {target}C"

    {% set start_temp = printer.extruder.temperature %}
    {% set start_time = printer.system_stats.cputime %}

    RESPOND MSG="Starting temp: {start_temp}C"
    RESPOND MSG="Starting heating..."

    M104 S{target}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={target}

    {% set end_time = printer.system_stats.cputime %}
    {% set duration = (end_time - start_time)|int %}
    {% set temp_gain = target - start_temp %}
    {% set rate = (temp_gain / duration * 60)|round(1) %}

    RESPOND MSG="=== Results ==="
    RESPOND MSG="Time: {duration}s"
    RESPOND MSG="Temp gain: {temp_gain}C"
    RESPOND MSG="Heating rate: {rate}C/min"
    RESPOND MSG="Dragon HF target: >180C/min"
    RESPOND MSG="==============="

    M104 S0

[gcode_macro NOZZLE_PRIME]
description: Prime Nozzle (kurze Extrusion)
gcode:
    {% set amount = params.AMOUNT|default(10)|float %}

    RESPOND MSG="Priming nozzle with {amount}mm"
    G92 E0
    G1 E{amount} F300
    G92 E0

[gcode_macro NOZZLE_CLEAN_PRIME]
description: Clean Prime (Extrude & Retract)
gcode:
    RESPOND MSG="Cleaning nozzle..."
    G92 E0
    G1 E15 F300        # Extrude 15mm
    G1 E10 F100        # Slow extrude
    G1 E5 F3000        # Fast retract
    G92 E0
    RESPOND MSG="Nozzle cleaned"

[gcode_macro HOTEND_COOLDOWN]
description: Schnelles Hotend Abkühlen
gcode:
    {% set target = params.TARGET|default(50)|int %}

    RESPOND MSG="Cooling hotend to {target}C"
    M104 S0

    # Part Cooling Fan auf 100% für schnelleres Kühlen
    M106 S255

    TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={target}

    M106 S0

    RESPOND MSG="Hotend cooled to {target}C"

[gcode_macro COLD_PULL]
description: Cold Pull für Düsenreinigung
gcode:
    RESPOND MSG="=== Cold Pull Procedure ==="
    RESPOND MSG="1. Heating to 230C..."

    M109 S230

    RESPOND MSG="2. Load cleaning filament"
    RESPOND MSG="3. Press when ready to continue"
    PAUSE

    RESPOND MSG="4. Cooling to 90C..."
    M109 S90

    RESPOND MSG="5. Pull filament NOW!"
    RESPOND MSG"6. Repeat if necessary"

    M104 S0

[gcode_macro TEMP_CHECK]
description: Überprüfe ob Hotend Zieltemperatur erreicht
gcode:
    {% set target = params.TARGET|default(200)|int %}
    {% set current = printer.extruder.temperature %}

    {% if current >= target - 5 %}
        RESPOND MSG="Hotend ready: {current}C (target: {target}C)"
    {% else %}
        RESPOND MSG="Hotend not ready: {current}C (target: {target}C)"
        RESPOND MSG="Waiting for temperature..."
        M109 S{target}
    {% endif %}

#####################################################################
#   Material-spezifische Hotend-Profile
#####################################################################

[gcode_macro LOAD_PLA]
description: Lade PLA Einstellungen
gcode:
    SET_PRESSURE_ADVANCE ADVANCE=0.035
    RESPOND MSG="PLA settings loaded (PA: 0.035)"

[gcode_macro LOAD_PETG]
description: Lade PETG Einstellungen
gcode:
    SET_PRESSURE_ADVANCE ADVANCE=0.045
    RESPOND MSG="PETG settings loaded (PA: 0.045)"

[gcode_macro LOAD_ABS]
description: Lade ABS Einstellungen
gcode:
    SET_PRESSURE_ADVANCE ADVANCE=0.030
    RESPOND MSG="ABS settings loaded (PA: 0.030)"

[gcode_macro LOAD_TPU]
description: Lade TPU Einstellungen
gcode:
    SET_PRESSURE_ADVANCE ADVANCE=0.055
    SET_VELOCITY_LIMIT ACCEL=3000    # Reduziert für TPU
    RESPOND MSG="TPU settings loaded (PA: 0.055, Accel: 3000)"
