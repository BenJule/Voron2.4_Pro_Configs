#####################################################################
#   PRINT_START - Anti-Oozing Optimized
#   Voron V2.4 R2 350 + Dragon HF
#####################################################################
[gcode_macro PRINT_START]
gcode:
  # LED Feedback
  LED_PCT_PRINT_START
  DISABLE_FILAMENT_SENSOR

  # Parameter vom Slicer
  {% set target_bed = params.BED|int %}
  {% set target_extruder = params.HOTEND|default(params.EXTRUDER)|int %}
  {% set filament_type = params.MATERIAL|default("PLA")|upper %}
  {% set target_chamber = params.CHAMBER|default("45")|int %}

  # Berechnete Positionen
  {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
  {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}

  SET_DISPLAY_TEXT MSG="Starting: {filament_type}"

  #####################################################################
  # 1. WARM-UP SEQUENCE
  #####################################################################
  
  STATUS_HEATING
  SET_DISPLAY_TEXT MSG="Pre-heating nozzle: 150°C"
  M104 S150                           # Conservative nozzle preheat
  
  SET_DISPLAY_TEXT MSG="Heating bed: {target_bed}°C"
  M140 S{target_bed}                  # Start bed heating (no wait)

  #####################################################################
  # 2. INITIALIZE & HOME
  #####################################################################
  
  STATUS_HOMING
  SET_DISPLAY_TEXT MSG="Homing..."
  
  G90                                 # Absolute positioning
  M83                                 # Relative extrusion
  
  G28                                 # Home all axes
  BED_MESH_CLEAR
  
  G1 Z5 F2000                        # Add clearance

  #####################################################################
  # 3. WAIT FOR BED
  #####################################################################
  
  STATUS_HEATING
  SET_DISPLAY_TEXT MSG="Waiting for bed: {target_bed}°C"
  
  # Park and wait for bed
  G1 X{x_wait} Y{y_wait} Z15 F9000
  M190 S{target_bed}                  # Wait for bed temperature

  # Material-specific heatsoak
  {% if filament_type in ["ABS", "ASA"] %}
    SET_DISPLAY_TEXT MSG="Chamber soak: {target_chamber}°C"
    {% if target_chamber > 0 %}
      TEMPERATURE_WAIT SENSOR="temperature_sensor Chamber" MINIMUM={target_chamber}
    {% else %}
      G4 P600000                      # 10min fallback
    {% endif %}
  {% elif target_bed > 90 %}
    SET_DISPLAY_TEXT MSG="Heatsoak: 5min"
    G4 P300000
  {% else %}
    SET_DISPLAY_TEXT MSG="Bed stabilizing: 3min"
    G4 P180000
  {% endif %}

  #####################################################################
  # 4. BED LEVELING (at 150°C)
  #####################################################################
  
  # Ensure nozzle is at 150°C for probing
  M109 S150
  
  STATUS_LEVELING
  SET_DISPLAY_TEXT MSG="QGL"
  QUAD_GANTRY_LEVEL
  G28 Z
  
  STATUS_MESHING
  SET_DISPLAY_TEXT MSG="Bed mesh (adaptive)"
  BED_MESH_CALIBRATE                  # KAMP adaptive mesh

  #####################################################################
  # 5. MOVE TO BUILD PLATE TAB & HEAT NOZZLE (ANTI-OOZING)
  #####################################################################
  
  STATUS_HEATING
  SET_DISPLAY_TEXT MSG="Positioning for purge"
  
  # Move high first to avoid dragging ooze
  G90
  G0 Z30 F3000                        # High position
  G0 X{x_wait} Y5 F9000               # Move to purge position XY (high)
  
  SET_DISPLAY_TEXT MSG="Heating nozzle: {target_extruder}°C"
  M107                                # Part cooling fan off
  
  # Heat in stages to reduce oozing
  {% if target_extruder > 200 %}
    M109 S{target_extruder - 20}      # Heat to target-20°C first
    G4 P2000                          # Short settle
    G0 Z0.3 F2000                     # Move to first layer height
    M109 S{target_extruder}           # Final temperature
  {% else %}
    G0 Z0.3 F2000                     # Move to first layer height
    M109 S{target_extruder}           # Heat to target
  {% endif %}
  
  # Anti-oozing retract after heating
  G92 E0
  G1 E-1.5 F1800                      # Strong retract to counter ooze
  G4 P500                             # Short wait

  #####################################################################
  # 6. PURGE LINE (at build plate tab)
  #####################################################################
  
  STATUS_PRINTING
  SET_DISPLAY_TEXT MSG="Purge line..."
  
  # Prime nozzle first
  G92 E0
  G1 E2.0 F500                        # Prime (overcome retract + fill)
  G4 P200                             # Brief settle
  
  # Purge line pattern
  G91                                 # Relative
  G1 X40 E10 F1200                   # Line forward
  G1 Y1                              # Step over
  G1 X-40 E10 F1200                  # Line back
  G1 E-1.0 F1800                     # Retract to prevent stringing
  G1 Z2 F3000                        # Lift
  G90                                # Absolute
  
  G4 P200                             # Brief settle

  #####################################################################
  # 7. FINAL PREP & START
  #####################################################################
  
  # Enable protections
  ENABLE_FILAMENT_SENSOR
  
  # LED to print mode
  LED_PCT_PRINT
  
  SET_DISPLAY_TEXT MSG="Printing: {filament_type}"
  STATUS_PRINTING
  
  M400                                # Wait for moves
