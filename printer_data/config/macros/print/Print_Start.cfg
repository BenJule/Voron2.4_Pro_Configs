#####################################################################
#   PRINT_START - Aggressive Anti-Oozing (Fixed)
#   Voron V2.4 R2 350 + Dragon HF
#####################################################################
[gcode_macro PRINT_START]
gcode:
  # LED Feedback
  LED_PCT_PRINT_START
  DISABLE_FILAMENT_SENSOR

  # Parameter vom Slicer
  {% set target_bed = params.BED|int %}
  {% set target_extruder = params.HOTEND|default(params.EXTRUDER)|int %}
  {% set filament_type = params.MATERIAL|default("PLA")|upper %}
  {% set target_chamber = params.CHAMBER|default("45")|int %}

  # Berechnete Positionen
  {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
  {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}

  SET_DISPLAY_TEXT MSG="Starting: {filament_type}"

  #####################################################################
  # 1. HOME FIRST (COLD)
  #####################################################################
  
  STATUS_HOMING
  SET_DISPLAY_TEXT MSG="Homing cold..."
  
  G90                                 # Absolute positioning
  M83                                 # Relative extrusion
  
  G28                                 # Home all axes COLD
  BED_MESH_CLEAR
  G1 Z5 F2000

  #####################################################################
  # 2. START BED HEATING ONLY
  #####################################################################
  
  STATUS_HEATING
  SET_DISPLAY_TEXT MSG="Heating bed: {target_bed}°C"
  M140 S{target_bed}                  # Start bed heating
  
  # Park and wait for bed
  G1 X{x_wait} Y{y_wait} Z15 F9000
  M190 S{target_bed}                  # Wait for bed

  # Material-specific heatsoak
  {% if filament_type in ["ABS", "ASA"] %}
    SET_DISPLAY_TEXT MSG="Chamber soak: {target_chamber}°C"
    {% if target_chamber > 0 %}
      TEMPERATURE_WAIT SENSOR="temperature_sensor Chamber" MINIMUM={target_chamber}
    {% else %}
      G4 P600000
    {% endif %}
  {% elif target_bed > 90 %}
    SET_DISPLAY_TEXT MSG="Heatsoak: 5min"
    G4 P300000
  {% else %}
    SET_DISPLAY_TEXT MSG="Bed stabilizing: 3min"
    G4 P180000
  {% endif %}

  #####################################################################
  # 3. HEAT NOZZLE TO 150°C FOR PROBING ONLY
  #####################################################################
  
  SET_DISPLAY_TEXT MSG="Pre-heating nozzle: 150°C"
  M109 S150                           # Heat to 150°C and WAIT

  #####################################################################
  # 4. BED LEVELING (at 150°C)
  #####################################################################
  
  STATUS_LEVELING
  SET_DISPLAY_TEXT MSG="QGL"
  QUAD_GANTRY_LEVEL
  G28 Z
  
  STATUS_MESHING
  SET_DISPLAY_TEXT MSG="Full bed mesh"
  BED_MESH_CALIBRATE ADAPTIVE=0       # Full mesh, not adaptive

  #####################################################################
  # 5. COOL DOWN TO 140°C (Anti-Oozing Strategy)
  #####################################################################
  
  SET_DISPLAY_TEXT MSG="Cooling to 140°C (anti-ooze)"
  M104 S140                           # Set 140°C (no wait)
  
  # Move to purge position while cooling
  G90
  G0 Z2 F3000                         # Low but not touching
  G0 X{x_wait} Y5 F9000               # Move to purge XY
  
  M109 S140                           # Wait for 140°C
  
  # Strong retract at 140°C
  G92 E0
  G1 E-5.0 F1800                      # MASSIVE retract
  G4 P1000
  
  # Lower to first layer
  G0 Z0.5 F2000

  #####################################################################
  # 6. FINAL HEAT TO 170°C FIRST (Anti-Oozing)
  #####################################################################
  
  STATUS_HEATING
  SET_DISPLAY_TEXT MSG="Heating to 170°C..."
  
  M107                                # Fan off
  M109 S170                           # Heat to safe extrude temp
  
  # IMMEDIATE retract after reaching 170°C
  G92 E0
  G1 E-2.0 F3000                      # Fast retract
  G4 P300

  #####################################################################
  # 7. FINAL HEAT TO TARGET (Fast!)
  #####################################################################
  
  SET_DISPLAY_TEXT MSG="Final heat: {target_extruder}°C"
  M104 S{target_extruder}             # Set target (no wait)
  
  # Short wait with monitoring to minimize ooze time
  TEMPERATURE_WAIT SENSOR=extruder MINIMUM={target_extruder - 2}
  
  # IMMEDIATE aggressive retract
  G92 E0
  G1 E-2.0 F3000                      # Fast strong retract
  G4 P200
  
  # Lower to first layer NOW
  G0 Z0.3 F2000

  #####################################################################
  # 8. PURGE LINE (FAST!)
  #####################################################################
  
  STATUS_PRINTING
  SET_DISPLAY_TEXT MSG="Purge..."
  
  # Prime aggressively (overcome all retracts: 5+2+2 = 9mm)
  G92 E0
  G1 E10.0 F500                       # Overcome all retracts + prime
  
  # FAST purge to minimize ooze time
  G91
  G1 X40 E12 F2000                    # Fast purge forward
  G1 Y1
  G1 X-40 E12 F2000                   # Fast purge back
  G1 E-1.5 F3000                      # Strong retract
  G1 Z3 F5000                         # Fast lift
  G90

  #####################################################################
  # 9. START PRINT
  #####################################################################
  
  ENABLE_FILAMENT_SENSOR
  LED_PCT_PRINT
  SET_DISPLAY_TEXT MSG="Printing: {filament_type}"
  STATUS_PRINTING
  M400
