#####################################################################
#   PRINT_START - Fixed Oozing Issue (no 140°C retract)
#   Voron V2.4 R2 350 + Dragon HF + KAMP
#####################################################################
[gcode_macro PRINT_START]
gcode:
  # LED Feedback
  LED_PCT_PRINT_START
  DISABLE_FILAMENT_SENSOR

  # Parameter vom Slicer
  {% set target_bed = params.BED|int %}
  {% set target_extruder = params.HOTEND|default(params.EXTRUDER)|int %}
  {% set filament_type = params.MATERIAL|default("PLA")|upper %}
  {% set target_chamber = params.CHAMBER|default("45")|int %}

  # Berechnete Positionen
  {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
  {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}

  SET_DISPLAY_TEXT MSG="Starting Print: {filament_type}"

  #####################################################################
  # PHASE 1: HOMING & INITIAL SETUP
  #####################################################################

  STATUS_HOMING
  SET_DISPLAY_TEXT MSG="Homing..."
  G28
  G90
  BED_MESH_CLEAR

  #####################################################################
  # PHASE 2: BED HEATING & HEATSOAK
  #####################################################################

  STATUS_HEATING
  SET_DISPLAY_TEXT MSG="Heating Bed: {target_bed}°C"

  # Move to center for even heating
  G1 X{x_wait} Y{y_wait} Z15 F9000

  # Material-specific bed heating strategy
  {% if filament_type == "TPU" %}
    # TPU: Quick heat, no soak
    SET_DISPLAY_TEXT MSG="TPU: Quick heating"
    M190 S{target_bed}

  {% elif filament_type in ["ABS", "ASA"] %}
    # ABS/ASA: High temp heatsoak with chamber
    M190 S{target_bed}
    SET_DISPLAY_TEXT MSG="Heatsoak: Chamber {target_chamber}°C"

    # Wait for chamber temperature
    {% if target_chamber > 0 %}
      TEMPERATURE_WAIT SENSOR="temperature_sensor Chamber" MINIMUM={target_chamber}
    {% else %}
      # Fallback: 10min soak if no chamber sensor target
      G4 P600000
    {% endif %}

  {% elif target_bed > 90 %}
    # High temp materials (generic)
    M190 S{target_bed}
    SET_DISPLAY_TEXT MSG="Heatsoak: 5min"
    G4 P300000

  {% else %}
    # PLA, PETG, PLA+ etc: Normal heating with short soak
    M190 S{target_bed}
    SET_DISPLAY_TEXT MSG="Stabilizing bed: 3min"
    G4 P180000  # 3min soak
  {% endif %}

  #####################################################################
  # PHASE 3: NOZZLE PRE-HEAT FOR PROBING (150°C - no oozing)
  #####################################################################

  SET_DISPLAY_TEXT MSG="Pre-heating nozzle: 150°C"
  M104 S150  # Start heating (non-blocking)

  #####################################################################
  # PHASE 4: QUAD GANTRY LEVELING
  #####################################################################

  STATUS_LEVELING
  SET_DISPLAY_TEXT MSG="QGL: Quad Gantry Level"

  M109 S150  # Wait for 150°C before QGL
  QUAD_GANTRY_LEVEL
  G28 Z

  #####################################################################
  # PHASE 5: BED MESH
  #####################################################################

  STATUS_MESHING
  SET_DISPLAY_TEXT MSG="Bed Mesh"

  M109 S150  # Ensure still at 150°C for mesh

  # Full mesh als Standard (sicher und funktioniert immer)
  # Adaptive mesh funktioniert erst nach erneutem Slicen mit label_objects=1
  SET_DISPLAY_TEXT MSG="Full Bed Mesh"
  BED_MESH_CALIBRATE ADAPTIVE=0

  #####################################################################
  # PHASE 6: MOVE TO PURGE POSITION (at 150°C - no oozing)
  #####################################################################

  SET_DISPLAY_TEXT MSG="Moving to purge position"

  # Keep at 150°C while moving (no oozing at this temp per user feedback)
  M104 S150

  # Move to purge position (ganz links am Rand der 75mm Lasche)
  G90
  G0 Z10 F3000                        # Safe height
  G0 X{(printer.toolhead.axis_maximum.x / 2) - 37.5} Y5 F9000  # Start ganz links
  G0 Z0.3 F2000                       # First layer height

  #####################################################################
  # PHASE 7: FAST HEATING + IMMEDIATE RETRACT (Anti-Oozing)
  #####################################################################

  STATUS_HEATING
  SET_DISPLAY_TEXT MSG="Heating to {target_extruder}°C"

  M107                                # Part cooling fan off

  # Fast heat from 150°C to target
  M109 S{target_extruder}

  # IMMEDIATE strong retract to prevent oozing
  DISABLE_FILAMENT_SENSOR             # Deaktiviere Sensor für Retract
  G92 E0
  G1 E-10.0 F3000                     # 10mm retract immediately after reaching temp
  G4 P500                             # Short wait

  #####################################################################
  # PHASE 8: PURGE LINE (über die ganze 75mm Lasche)
  #####################################################################

  STATUS_PRINTING
  SET_DISPLAY_TEXT MSG="Purging..."

  # Erste Purge Line
  G92 E0
  G1 E13.0 F300                       # 13mm prime (10mm + 3mm extra für gute Extrusion)
  G92 E0
  G1 X{(printer.toolhead.axis_maximum.x / 2) + 37.5} E15 F1500  # 75mm purge mit mehr Material
  G92 E0

  # Hoch heben für Rückfahrt
  G0 Z0.5 F2000

  # Zurück zu links für zweite Linie
  G0 X{(printer.toolhead.axis_maximum.x / 2) - 37.5} Y7 F9000  # 2mm weiter hinten
  G0 Z0.3 F2000

  # Zweite Purge Line
  G92 E0
  G1 X{(printer.toolhead.axis_maximum.x / 2) + 37.5} E15 F1500  # 75mm purge zweite Linie
  G92 E0
  G1 E-1.0 F1800                      # Stärkerer retract am Ende
  G92 E0

  #####################################################################
  # PHASE 9: START PRINT
  #####################################################################

  # LED auf Print-Modus
  LED_PCT_PRINT

  # Filament Sensor aktivieren
  ENABLE_FILAMENT_SENSOR

  SET_DISPLAY_TEXT MSG="Printing: {filament_type}"
  STATUS_PRINTING
