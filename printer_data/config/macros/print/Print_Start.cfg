#####################################################################
#   PRINT_START - Aggressive Anti-Oozing
#   Voron V2.4 R2 350 + Dragon HF
#####################################################################
[gcode_macro PRINT_START]
gcode:
  # LED Feedback
  LED_PCT_PRINT_START
  DISABLE_FILAMENT_SENSOR

  # Parameter vom Slicer
  {% set target_bed = params.BED|int %}
  {% set target_extruder = params.HOTEND|default(params.EXTRUDER)|int %}
  {% set filament_type = params.MATERIAL|default("PLA")|upper %}
  {% set target_chamber = params.CHAMBER|default("45")|int %}

  # Berechnete Positionen
  {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
  {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}

  SET_DISPLAY_TEXT MSG="Starting: {filament_type}"

  #####################################################################
  # 1. HOME FIRST (COLD)
  #####################################################################
  
  STATUS_HOMING
  SET_DISPLAY_TEXT MSG="Homing cold..."
  
  G90                                 # Absolute positioning
  M83                                 # Relative extrusion
  
  G28                                 # Home all axes COLD
  BED_MESH_CLEAR
  G1 Z5 F2000

  #####################################################################
  # 2. START BED HEATING ONLY
  #####################################################################
  
  STATUS_HEATING
  SET_DISPLAY_TEXT MSG="Heating bed: {target_bed}°C"
  M140 S{target_bed}                  # Start bed heating
  
  # Park and wait for bed
  G1 X{x_wait} Y{y_wait} Z15 F9000
  M190 S{target_bed}                  # Wait for bed

  # Material-specific heatsoak
  {% if filament_type in ["ABS", "ASA"] %}
    SET_DISPLAY_TEXT MSG="Chamber soak: {target_chamber}°C"
    {% if target_chamber > 0 %}
      TEMPERATURE_WAIT SENSOR="temperature_sensor Chamber" MINIMUM={target_chamber}
    {% else %}
      G4 P600000
    {% endif %}
  {% elif target_bed > 90 %}
    SET_DISPLAY_TEXT MSG="Heatsoak: 5min"
    G4 P300000
  {% else %}
    SET_DISPLAY_TEXT MSG="Bed stabilizing: 3min"
    G4 P180000
  {% endif %}

  #####################################################################
  # 3. HEAT NOZZLE TO 150°C FOR PROBING ONLY
  #####################################################################
  
  SET_DISPLAY_TEXT MSG="Pre-heating nozzle: 150°C"
  M109 S150                           # Heat to 150°C and WAIT

  #####################################################################
  # 4. BED LEVELING (at 150°C)
  #####################################################################
  
  STATUS_LEVELING
  SET_DISPLAY_TEXT MSG="QGL"
  QUAD_GANTRY_LEVEL
  G28 Z
  
  STATUS_MESHING
  SET_DISPLAY_TEXT MSG="Bed mesh"
  BED_MESH_CALIBRATE

  #####################################################################
  # 5. COOL DOWN TO 140°C (Anti-Oozing Strategy)
  #####################################################################
  
  SET_DISPLAY_TEXT MSG="Cooling to 140°C (anti-ooze)"
  M109 S140                           # Cool to 140°C
  
  # Strong retract at 140°C
  G92 E0
  G1 E-5.0 F1800                      # MASSIVE retract
  G4 P1000

  #####################################################################
  # 6. MOVE TO PURGE POSITION (NOZZLE COLD-ISH)
  #####################################################################
  
  SET_DISPLAY_TEXT MSG="Moving to purge position"
  G90
  G0 Z2 F3000                         # Low but not touching
  G0 X{x_wait} Y5 F9000               # Move to purge XY
  G0 Z0.5 F2000                       # Just above first layer

  #####################################################################
  # 7. FINAL HEAT (AGGRESSIVE ANTI-OOZE)
  #####################################################################
  
  STATUS_HEATING
  SET_DISPLAY_TEXT MSG="Final heating: {target_extruder}°C"
  
  M107                                # Fan off
  M104 S{target_extruder}             # Set target (no wait)
  
  # Wait with active monitoring
  {% set heat_time = 0 %}
  {% for i in range(60) %}
    {% if printer.extruder.temperature < target_extruder - 5 %}
      G4 P1000                        # Wait 1 second
      {% set heat_time = heat_time + 1 %}
    {% endif %}
  {% endfor %}
  
  M109 S{target_extruder}             # Final wait
  
  # IMMEDIATE aggressive retract after reaching temp
  G92 E0
  G1 E-3.0 F3000                      # Fast strong retract
  G4 P500
  
  # Lower to first layer NOW
  G0 Z0.3 F2000

  #####################################################################
  # 8. PURGE LINE (FAST!)
  #####################################################################
  
  STATUS_PRINTING
  SET_DISPLAY_TEXT MSG="Purge..."
  
  # Prime aggressively
  G92 E0
  G1 E5.0 F500                        # Overcome all retracts
  
  # FAST purge to minimize ooze time
  G91
  G1 X40 E12 F2000                    # Fast purge forward
  G1 Y1
  G1 X-40 E12 F2000                   # Fast purge back
  G1 E-1.5 F3000                      # Strong retract
  G1 Z3 F5000                         # Fast lift
  G90

  #####################################################################
  # 9. START PRINT
  #####################################################################
  
  ENABLE_FILAMENT_SENSOR
  LED_PCT_PRINT
  SET_DISPLAY_TEXT MSG="Printing: {filament_type}"
  STATUS_PRINTING
  M400
