#####################################################################
#   OPTIMIZED PRINT_END - Voron V2.4 R2 350 + Dragon HF
#####################################################################

[gcode_macro PARK]
description: Parks toolhead in center at Z30
gcode:
    {% set th = printer.toolhead %}
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y//2} Z30 F9000

[gcode_macro G32]
description: Home, QGL, Home Z, Park
gcode:
    SAVE_GCODE_STATE NAME=STATE_G32
    STATUS_HOMING
    G90
    G28
    STATUS_LEVELING
    QUAD_GANTRY_LEVEL
    G28 Z
    PARK
    STATUS_READY
    RESTORE_GCODE_STATE NAME=STATE_G32

[gcode_macro PRINT_END]
description: End print routine with material-aware post-processing
gcode:
    # Parameter für Material (optional vom Slicer)
    {% set filament_type = params.MATERIAL|default("PLA")|upper %}

    # Toolhead Position berechnen
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 10, th.axis_maximum.z]|min %}  # 10mm lift statt 2mm!

    SAVE_GCODE_STATE NAME=STATE_PRINT_END

    SET_DISPLAY_TEXT MSG="Print finished!"

    #####################################################################
    # PHASE 1: RETRACT & MOVE
    #####################################################################

    M400                           # Wait for buffer to clear
    G92 E0                         # Zero extruder
    G1 E-5.0 F1800                # Retract 5mm

    #####################################################################
    # PHASE 2: SAFE POSITIONING
    #####################################################################

    G90                                      # Absolute positioning
    G0 X{x_safe} Y{y_safe} Z{z_safe} F20000 # Anti-stringing move (10mm up!)

    # Park nozzle at rear center
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y - 5} F9000

    #####################################################################
    # PHASE 3: SHUTDOWN HEATERS & FANS
    #####################################################################

    TURN_OFF_HEATERS
    M107  # Part cooling fan off

    #####################################################################
    # PHASE 4: MATERIAL-SPECIFIC POST-PROCESSING
    #####################################################################

    {% if filament_type in ["ABS", "ASA"] %}
      # ABS/ASA: Activate exhaust for chamber purge
      SET_DISPLAY_TEXT MSG="Purging chamber (ABS/ASA)"
      # M141 S100  # Exhaust fan 100% (uncomment if you have M141)

      # Wait 5 minutes for chamber cooldown
      SET_DISPLAY_TEXT MSG="Chamber purge: 5min"
      G4 P300000  # 5 minutes

      # Turn off exhaust
      # M141 S0

    {% elif filament_type == "PETG" %}
      # PETG: Moderate exhaust
      SET_DISPLAY_TEXT MSG="Cooling PETG"
      # M141 S50
      G4 P60000  # 1 minute
      # M141 S0

    {% else %}
      # PLA, PLA+, TPU: Quick cooldown
      SET_DISPLAY_TEXT MSG="Cooling {filament_type}"
      G4 P30000  # 30 seconds
    {% endif %}

    #####################################################################
    # PHASE 5: FINAL CLEANUP
    #####################################################################

    M400                           # Wait for moves to finish

    # Bed to 40°C for easy part removal (optional)
    # M140 S40

    # LED to idle/complete
    LED_PCT_PRINT_STOP
    STATUS_READY

    # Disable filament sensor
    DISABLE_FILAMENT_SENSOR

    SET_DISPLAY_TEXT MSG="Ready for next print!"

    RESTORE_GCODE_STATE NAME=STATE_PRINT_END

    # Beep (if configured)
    # M300 S1000 P500