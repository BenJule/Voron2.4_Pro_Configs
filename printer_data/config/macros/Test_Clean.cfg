[gcode_macro TEST_CLEAN_NOZZLE]
description: "Testmakro: Hotend aufheizen, Filament purgen und vorne-links wipen"
variable_temp: 200            # Testtemperatur
variable_purge_length: 20     # Länge des Purges in mm
variable_purge_speed: 5       # Geschwindigkeit Purge mm/s
variable_start_x: 35          # Startposition X vorne-links
variable_start_y: 0           # Startposition Y vorne
variable_start_z: 4           # Startposition Z
variable_wipe_dist: 80        # Wipe-Distanz X
variable_wipe_qty: 3          # Anzahl Zickzack-Wipes
variable_wipe_y_offset: 2     # Y-Offset Zickzack
variable_retract_length: 5    # Retract-Länge
variable_retract_speed: 25    # Retract-Geschwindigkeit
variable_raise_distance: 20   # Höhe nach Wipe
variable_pause_time: 500      # Pause nach Wipe (ms)

gcode:
  # Homing falls nötig
  {% if 'x' not in printer.toolhead.homed_axes or
        'y' not in printer.toolhead.homed_axes or
        'z' not in printer.toolhead.homed_axes %}
    G28
  {% endif %}

  # Absolutes Positionieren
  G90
  G1 X{start_x} Y{start_y} F6000
  G1 Z{start_z} F1500

  # Hotend aufheizen
  M104 S{temp}
  M109 S{temp}

  # Purge (Filament etwas extrudieren)
  G92 E0
  G1 E{purge_length} F{purge_speed * 60}
  G92 E0

  # Zickzack-Wipe vorne-links
  {% set current_x = start_x %}
  {% set current_y = start_y %}
  {% for i in range(wipe_qty) %}
    G1 X{current_x + wipe_dist} Y{current_y} F{150*60}  ; Wipe nach rechts
    G1 X{current_x} Y{current_y + wipe_y_offset} F{150*60}  ; zurück mit Y-Offset
    {% set current_y = current_y + wipe_y_offset %}
  {% endfor %}

  # Kurze Pause
  G4 P{pause_time}

  # Retract, um Oozing zu verhindern
  G1 E-{retract_length} F{retract_speed * 60}

  # Düse anheben
  G1 Z{raise_distance} F1500

  # Abkühlen
  M104 S0
  SET_DISPLAY_TEXT MSG="Test Clean Done"
