#####################################################################
#   Pressure Advance - Dragon HF Optimiert
#####################################################################

[extruder]
# Pressure Advance wird nach Kalibrierung hier gesetzt
pressure_advance: 0.035        # Startwert für Dragon HF (muss kalibriert werden)
pressure_advance_smooth_time: 0.040

#####################################################################
#   Pressure Advance Kalibrierung
#####################################################################

[gcode_macro PA_CALIBRATE_START]
description: Startet PA-Kalibrierung (Druck Testmuster)
gcode:
    {% set bed_temp = params.BED|default(60)|int %}
    {% set extruder_temp = params.EXTRUDER|default(220)|int %}

    RESPOND MSG="Starting Pressure Advance Calibration"
    RESPOND MSG="Bed: {bed_temp}°C, Extruder: {extruder_temp}°C"

    # Vorbereitung
    G28
    QUAD_GANTRY_LEVEL
    G28 Z
    BED_MESH_CALIBRATE

    # Aufheizen
    M190 S{bed_temp}
    M109 S{extruder_temp}

    RESPOND MSG="Ready for PA test print"
    RESPOND MSG="Use: TUNING_TOWER COMMAND=SET_PRESSURE_ADVANCE PARAMETER=ADVANCE START=0 FACTOR=.005"

[gcode_macro SET_PA]
description: Setze Pressure Advance manuell
gcode:
    {% set pa = params.PA|default(0.035)|float %}
    SET_PRESSURE_ADVANCE ADVANCE={pa}
    RESPOND MSG="Pressure Advance set to {pa}"

[gcode_macro PA_TEST]
description: Schneller PA-Test (ohne Druck)
gcode:
    {% set start_pa = params.START|default(0.0)|float %}
    {% set end_pa = params.END|default(0.1)|float %}
    {% set steps = params.STEPS|default(10)|int %}

    RESPOND MSG="PA Test: {start_pa} to {end_pa} in {steps} steps"

    {% set pa_increment = (end_pa - start_pa) / steps %}
    {% for i in range(steps + 1) %}
        {% set current_pa = start_pa + (i * pa_increment) %}
        SET_PRESSURE_ADVANCE ADVANCE={current_pa}
        RESPOND MSG="Step {i}: PA={current_pa}"
        G4 P1000
    {% endfor %}

#####################################################################
#   Material-spezifische PA-Profile
#####################################################################

[gcode_macro PA_PLA]
description: Pressure Advance für PLA
gcode:
    SET_PRESSURE_ADVANCE ADVANCE=0.035
    RESPOND MSG="PA set for PLA: 0.035"

[gcode_macro PA_PETG]
description: Pressure Advance für PETG
gcode:
    SET_PRESSURE_ADVANCE ADVANCE=0.045
    RESPOND MSG="PA set for PETG: 0.045"

[gcode_macro PA_ABS]
description: Pressure Advance für ABS
gcode:
    SET_PRESSURE_ADVANCE ADVANCE=0.030
    RESPOND MSG="PA set for ABS: 0.030"

[gcode_macro PA_TPU]
description: Pressure Advance für TPU
gcode:
    SET_PRESSURE_ADVANCE ADVANCE=0.055
    RESPOND MSG="PA set for TPU: 0.055"

#####################################################################
#   Extrusion Multiplier Tuning
#####################################################################

[gcode_macro SET_EM]
description: Setze Extrusion Multiplier (Flow Rate)
gcode:
    {% set em = params.EM|default(1.0)|float %}
    M221 S{em * 100}
    RESPOND MSG="Extrusion Multiplier set to {em} ({em * 100}%)"

[gcode_macro EM_TEST]
description: Teste verschiedene Extrusion Multiplier
gcode:
    {% set start_em = params.START|default(0.95)|float %}
    {% set end_em = params.END|default(1.05)|float %}
    {% set steps = params.STEPS|default(5)|int %}

    RESPOND MSG="EM Test: {start_em} to {end_em} in {steps} steps"

    {% set em_increment = (end_em - start_em) / steps %}
    {% for i in range(steps + 1) %}
        {% set current_em = start_em + (i * em_increment) %}
        M221 S{current_em * 100}
        RESPOND MSG="Step {i}: EM={current_em} ({current_em * 100}%)"
        G4 P2000
    {% endfor %}
