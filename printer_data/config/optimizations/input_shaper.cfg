#####################################################################
#   Input Shaper Configuration - Voron 2.4 R2 350
#   Dragon HF Hotend + EBB36 CAN Toolhead
#####################################################################

[resonance_tester]
accel_chip: adxl345
probe_points:
    175, 175, 20  # Center of 350mm bed

[input_shaper]
# Diese Werte werden nach Resonanztest automatisch gesetzt
# Führe aus: SHAPER_CALIBRATE
# Danach: SAVE_CONFIG
shaper_freq_x: 0
shaper_freq_y: 0
shaper_type: mzv

#####################################################################
#   Enhanced Motion Configuration
#####################################################################

[printer]
kinematics: corexy
max_velocity: 710
max_accel: 10000              # Erhöht von 4000 (nach Input Shaper Test anpassen)
max_accel_to_decel: 5000      # 50% von max_accel für sanfte Beschleunigung
max_z_velocity: 25            # Erhöht von Standard für schnelleres Probing
max_z_accel: 500              # Erhöht für schnellere Z-Moves
square_corner_velocity: 8.0   # Kann nach Tests auf 10-12 erhöht werden
minimum_cruise_ratio: 0.5

#####################################################################
#   Acceleration Control Macros
#####################################################################

[gcode_macro SET_ACCEL_PROFILE]
description: Schnell zwischen Acceleration-Profilen wechseln
gcode:
    {% set profile = params.PROFILE|default("NORMAL")|upper %}

    {% if profile == "SPEED" %}
        SET_VELOCITY_LIMIT ACCEL=12000 ACCEL_TO_DECEL=6000
        RESPOND MSG="Speed Profile: 12000mm/s² accel"
    {% elif profile == "NORMAL" %}
        SET_VELOCITY_LIMIT ACCEL=10000 ACCEL_TO_DECEL=5000
        RESPOND MSG="Normal Profile: 10000mm/s² accel"
    {% elif profile == "QUALITY" %}
        SET_VELOCITY_LIMIT ACCEL=5000 ACCEL_TO_DECEL=2500
        RESPOND MSG="Quality Profile: 5000mm/s² accel"
    {% elif profile == "SILENT" %}
        SET_VELOCITY_LIMIT ACCEL=3000 ACCEL_TO_DECEL=1500
        RESPOND MSG="Silent Profile: 3000mm/s² accel"
    {% endif %}

[gcode_macro ACCEL_SPEED]
description: Speed Mode (12000mm/s²)
gcode:
    SET_ACCEL_PROFILE PROFILE=SPEED

[gcode_macro ACCEL_NORMAL]
description: Normal Mode (10000mm/s²)
gcode:
    SET_ACCEL_PROFILE PROFILE=NORMAL

[gcode_macro ACCEL_QUALITY]
description: Quality Mode (5000mm/s²)
gcode:
    SET_ACCEL_PROFILE PROFILE=QUALITY

[gcode_macro ACCEL_SILENT]
description: Silent Mode (3000mm/s²)
gcode:
    SET_ACCEL_PROFILE PROFILE=SILENT

#####################################################################
#   Input Shaper Testing Macros
#####################################################################

[gcode_macro TEST_RESONANCES_X]
description: Test X-Achse Resonanzen
gcode:
    RESPOND MSG="Testing X-Axis resonances..."
    G28
    SHAPER_CALIBRATE AXIS=X

[gcode_macro TEST_RESONANCES_Y]
description: Test Y-Achse Resonanzen
gcode:
    RESPOND MSG="Testing Y-Axis resonances..."
    G28
    SHAPER_CALIBRATE AXIS=Y

[gcode_macro TEST_RESONANCES_ALL]
description: Test beide Achsen (dauert ~20min)
gcode:
    RESPOND MSG="Testing all axes resonances (20min)..."
    G28
    SHAPER_CALIBRATE
    RESPOND MSG="Test complete! Review results and SAVE_CONFIG"

[gcode_macro VIBRATION_TEST]
description: Schneller Vibrations-Test für Mechanik-Check
gcode:
    {% set speed = params.SPEED|default(300)|int %}
    {% set accel = params.ACCEL|default(10000)|int %}

    RESPOND MSG="Vibration test at {speed}mm/s, {accel}mm/s²"

    G28
    G90
    G0 Z20 F3000

    SET_VELOCITY_LIMIT ACCEL={accel}

    # X-Achse Test
    RESPOND MSG="Testing X-Axis..."
    G0 X50 Y175 F{speed * 60}
    G0 X300 F{speed * 60}
    G0 X50 F{speed * 60}
    G0 X300 F{speed * 60}

    # Y-Achse Test
    RESPOND MSG="Testing Y-Axis..."
    G0 X175 Y50 F{speed * 60}
    G0 Y300 F{speed * 60}
    G0 Y50 F{speed * 60}
    G0 Y300 F{speed * 60}

    # Diagonal Test
    RESPOND MSG="Testing Diagonals..."
    G0 X50 Y50 F{speed * 60}
    G0 X300 Y300 F{speed * 60}
    G0 X50 Y300 F{speed * 60}
    G0 X300 Y50 F{speed * 60}

    G0 X175 Y175 F{speed * 60}
    RESPOND MSG="Vibration test complete"
