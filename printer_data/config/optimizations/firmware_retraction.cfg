#####################################################################
#   Firmware Retraction - Dragon HF Optimiert
#   Ermöglicht Runtime-Anpassung ohne Slicer-Neuslicing
#####################################################################

[firmware_retraction]
retract_length: 0.5              # Dragon HF: kurze Retracts (DirectDrive)
retract_speed: 40                # Retract-Geschwindigkeit mm/s
unretract_extra_length: 0.0      # Kein Extra beim Unretract
unretract_speed: 35              # Unretract-Geschwindigkeit mm/s
z_hop_height: 0.2                # Z-Hop bei Retract (optional)

#####################################################################
#   Retraction Profile Management
#####################################################################

[gcode_macro RETRACT_PROFILE]
description: Wechsle zwischen Retraction-Profilen
gcode:
    {% set profile = params.PROFILE|default("STANDARD")|upper %}

    {% if profile == "STANDARD" %}
        SET_RETRACTION RETRACT_LENGTH=0.5 RETRACT_SPEED=40 UNRETRACT_SPEED=35
        RESPOND MSG="Standard Profile: 0.5mm @ 40mm/s"

    {% elif profile == "PLA" %}
        SET_RETRACTION RETRACT_LENGTH=0.4 RETRACT_SPEED=45 UNRETRACT_SPEED=40
        RESPOND MSG="PLA Profile: 0.4mm @ 45mm/s"

    {% elif profile == "PETG" %}
        SET_RETRACTION RETRACT_LENGTH=0.6 RETRACT_SPEED=35 UNRETRACT_SPEED=30
        RESPOND MSG="PETG Profile: 0.6mm @ 35mm/s (slower for strings)"

    {% elif profile == "ABS" %}
        SET_RETRACTION RETRACT_LENGTH=0.5 RETRACT_SPEED=40 UNRETRACT_SPEED=35
        RESPOND MSG="ABS Profile: 0.5mm @ 40mm/s"

    {% elif profile == "TPU" %}
        SET_RETRACTION RETRACT_LENGTH=0.2 RETRACT_SPEED=20 UNRETRACT_SPEED=15
        RESPOND MSG="TPU Profile: 0.2mm @ 20mm/s (soft)"

    {% elif profile == "STRINGING" %}
        SET_RETRACTION RETRACT_LENGTH=0.8 RETRACT_SPEED=50 UNRETRACT_SPEED=40
        RESPOND MSG="Anti-Stringing: 0.8mm @ 50mm/s"

    {% elif profile == "NONE" %}
        SET_RETRACTION RETRACT_LENGTH=0.0
        RESPOND MSG="Retraction disabled"

    {% endif %}

[gcode_macro RETRACT_PLA]
description: Retraction für PLA
gcode:
    RETRACT_PROFILE PROFILE=PLA

[gcode_macro RETRACT_PETG]
description: Retraction für PETG
gcode:
    RETRACT_PROFILE PROFILE=PETG

[gcode_macro RETRACT_ABS]
description: Retraction für ABS
gcode:
    RETRACT_PROFILE PROFILE=ABS

[gcode_macro RETRACT_TPU]
description: Retraction für TPU
gcode:
    RETRACT_PROFILE PROFILE=TPU

#####################################################################
#   Z-Hop Management
#####################################################################

[gcode_macro SET_ZHOP]
description: Z-Hop ein/aus/anpassen
gcode:
    {% set height = params.HEIGHT|default(0.2)|float %}

    {% if height > 0 %}
        SET_RETRACTION Z_HOP_HEIGHT={height}
        RESPOND MSG="Z-Hop enabled: {height}mm"
    {% else %}
        SET_RETRACTION Z_HOP_HEIGHT=0
        RESPOND MSG="Z-Hop disabled"
    {% endif %}

[gcode_macro ZHOP_ON]
description: Z-Hop aktivieren (0.2mm)
gcode:
    SET_ZHOP HEIGHT=0.2

[gcode_macro ZHOP_OFF]
description: Z-Hop deaktivieren
gcode:
    SET_ZHOP HEIGHT=0

#####################################################################
#   Retraction Testing & Tuning
#####################################################################

[gcode_macro RETRACT_TEST]
description: Test verschiedene Retraction-Längen
gcode:
    {% set start_length = params.START|default(0.2)|float %}
    {% set end_length = params.END|default(1.0)|float %}
    {% set steps = params.STEPS|default(5)|int %}

    RESPOND MSG="Retraction Test: {start_length}mm to {end_length}mm"

    {% set length_increment = (end_length - start_length) / steps %}
    {% for i in range(steps + 1) %}
        {% set current_length = start_length + (i * length_increment) %}
        SET_RETRACTION RETRACT_LENGTH={current_length}
        RESPOND MSG="Step {i}: Retract={current_length}mm"
        G4 P2000
    {% endfor %}

[gcode_macro RETRACT_CALIBRATE]
description: Interaktive Retraction-Kalibrierung
gcode:
    RESPOND MSG="=== Retraction Calibration ==="
    RESPOND MSG="1. Print retraction test tower"
    RESPOND MSG="2. Use RETRACT_TEST or manually adjust:"
    RESPOND MSG="   SET_RETRACTION RETRACT_LENGTH=X.X"
    RESPOND MSG="3. Find best retraction distance"
    RESPOND MSG="4. Update [firmware_retraction] in config"
    RESPOND MSG="===================================="

#####################################################################
#   Advanced Retraction Features
#####################################################################

[gcode_macro RETRACT_INFO]
description: Zeige aktuelle Retraction-Einstellungen
gcode:
    {% set retract = printer.firmware_retraction %}
    RESPOND MSG="=== Current Retraction Settings ==="
    RESPOND MSG="Retract Length: {retract.retract_length}mm"
    RESPOND MSG="Retract Speed: {retract.retract_speed}mm/s"
    RESPOND MSG="Unretract Speed: {retract.unretract_speed}mm/s"
    RESPOND MSG="Z-Hop: {retract.z_hop_height}mm"
    RESPOND MSG="===================================="

[gcode_macro RETRACT_FINE_TUNE]
description: Fein-Tuning während des Drucks
gcode:
    {% set adjust = params.ADJUST|default(0.0)|float %}
    {% set current = printer.firmware_retraction.retract_length %}
    {% set new_length = current + adjust %}

    SET_RETRACTION RETRACT_LENGTH={new_length}
    RESPOND MSG="Retract adjusted from {current}mm to {new_length}mm"
