#####################################################################
#   Save Variables - Persistente Einstellungen
#   Speichert Werte die Neustarts überleben
#####################################################################

[save_variables]
filename: ~/printer_data/config/saved_variables.cfg

#####################################################################
#   Variable Management Macros
#####################################################################

[gcode_macro SAVE_VAR]
description: Speichere Variable
gcode:
    {% set var_name = params.NAME %}
    {% set var_value = params.VALUE %}
    SAVE_VARIABLE VARIABLE={var_name} VALUE={var_value}
    RESPOND MSG="Saved: {var_name} = {var_value}"

[gcode_macro LOAD_VAR]
description: Lade Variable
gcode:
    {% set var_name = params.NAME %}
    {% set vars = printer.save_variables.variables %}
    {% if var_name in vars %}
        RESPOND MSG="{var_name} = {vars[var_name]}"
    {% else %}
        RESPOND MSG="{var_name} not found"
    {% endif %}

[gcode_macro LIST_VARS]
description: Liste alle gespeicherten Variablen
gcode:
    {% set vars = printer.save_variables.variables %}
    RESPOND MSG="=== Saved Variables ==="
    {% for name in vars %}
        RESPOND MSG="{name} = {vars[name]}"
    {% endfor %}
    RESPOND MSG="======================="

#####################################################################
#   Z-Offset Management (per Build Plate)
#####################################################################

[gcode_macro SAVE_ZOFFSET]
description: Speichere aktuellen Z-Offset für Build Plate
gcode:
    {% set plate = params.PLATE|default("default")|string %}
    {% set offset = printer.gcode_move.homing_origin.z %}

    SAVE_VARIABLE VARIABLE=zoffset_{plate} VALUE={offset}
    RESPOND MSG="Z-Offset saved for plate '{plate}': {offset}mm"

[gcode_macro LOAD_ZOFFSET]
description: Lade Z-Offset für Build Plate
gcode:
    {% set plate = params.PLATE|default("default")|string %}
    {% set vars = printer.save_variables.variables %}
    {% set var_name = "zoffset_" ~ plate %}

    {% if var_name in vars %}
        {% set offset = vars[var_name] %}
        SET_GCODE_OFFSET Z={offset}
        RESPOND MSG="Z-Offset loaded for plate '{plate}': {offset}mm"
    {% else %}
        RESPOND MSG="No Z-Offset saved for plate '{plate}'"
    {% endif %}

[gcode_macro LIST_ZOFFSETS]
description: Liste alle gespeicherten Z-Offsets
gcode:
    {% set vars = printer.save_variables.variables %}
    RESPOND MSG="=== Saved Z-Offsets ==="
    {% for name in vars %}
        {% if name.startswith("zoffset_") %}
            {% set plate = name.replace("zoffset_", "") %}
            RESPOND MSG="{plate}: {vars[name]}mm"
        {% endif %}
    {% endfor %}
    RESPOND MSG="======================="

#####################################################################
#   Print Statistics Tracking
#####################################################################

[gcode_macro INIT_STATS]
description: Initialisiere Print Statistics
gcode:
    SAVE_VARIABLE VARIABLE=total_prints VALUE=0
    SAVE_VARIABLE VARIABLE=total_print_time VALUE=0
    SAVE_VARIABLE VARIABLE=total_filament VALUE=0
    RESPOND MSG="Print statistics initialized"

[gcode_macro UPDATE_PRINT_STATS]
description: Update Print Statistics (automatisch)
gcode:
    {% set vars = printer.save_variables.variables %}
    {% set print_stats = printer.print_stats %}

    # Nur bei erfolgreichem Druck
    {% if print_stats.state == "complete" %}
        # Total Prints
        {% set total_prints = vars.total_prints|default(0)|int + 1 %}
        SAVE_VARIABLE VARIABLE=total_prints VALUE={total_prints}

        # Total Print Time
        {% set total_time = vars.total_print_time|default(0)|float + print_stats.print_duration %}
        SAVE_VARIABLE VARIABLE=total_print_time VALUE={total_time}

        # Total Filament
        {% set total_filament = vars.total_filament|default(0)|float + print_stats.filament_used %}
        SAVE_VARIABLE VARIABLE=total_filament VALUE={total_filament}

        RESPOND MSG="Print stats updated: Print #{total_prints}"
    {% endif %}

[gcode_macro SHOW_STATS]
description: Zeige Print Statistics
gcode:
    {% set vars = printer.save_variables.variables %}
    {% set total_prints = vars.total_prints|default(0)|int %}
    {% set total_time = vars.total_print_time|default(0)|float %}
    {% set total_filament = vars.total_filament|default(0)|float %}

    {% set hours = (total_time / 3600)|int %}
    {% set filament_kg = (total_filament / 1000)|round(2) %}

    RESPOND MSG="=== Print Statistics ==="
    RESPOND MSG="Total Prints: {total_prints}"
    RESPOND MSG="Total Time: {hours}h ({total_time|round(0)}s)"
    RESPOND MSG="Total Filament: {filament_kg}kg ({total_filament|round(0)}mm)"
    RESPOND MSG="========================"

#####################################################################
#   Maintenance Tracking
#####################################################################

[gcode_macro INIT_MAINTENANCE]
description: Initialisiere Maintenance Counters
gcode:
    SAVE_VARIABLE VARIABLE=nozzle_changes VALUE=0
    SAVE_VARIABLE VARIABLE=last_nozzle_change VALUE=0
    SAVE_VARIABLE VARIABLE=belt_tension_check VALUE=0
    SAVE_VARIABLE VARIABLE=filter_changes VALUE=0
    RESPOND MSG="Maintenance counters initialized"

[gcode_macro NOZZLE_CHANGED]
description: Markiere Nozzle-Wechsel
gcode:
    {% set vars = printer.save_variables.variables %}
    {% set total_prints = vars.total_prints|default(0)|int %}
    {% set nozzle_changes = vars.nozzle_changes|default(0)|int + 1 %}

    SAVE_VARIABLE VARIABLE=nozzle_changes VALUE={nozzle_changes}
    SAVE_VARIABLE VARIABLE=last_nozzle_change VALUE={total_prints}

    RESPOND MSG="Nozzle change #{nozzle_changes} recorded at print #{total_prints}"

[gcode_macro MAINTENANCE_INFO]
description: Zeige Maintenance Info
gcode:
    {% set vars = printer.save_variables.variables %}
    {% set total_prints = vars.total_prints|default(0)|int %}
    {% set last_nozzle = vars.last_nozzle_change|default(0)|int %}
    {% set prints_since_nozzle = total_prints - last_nozzle %}

    RESPOND MSG="=== Maintenance Info ==="
    RESPOND MSG="Nozzle Changes: {vars.nozzle_changes|default(0)}"
    RESPOND MSG="Prints since last change: {prints_since_nozzle}"

    {% if prints_since_nozzle > 500 %}
        RESPOND MSG="⚠️ Consider nozzle inspection (>{500} prints)"
    {% endif %}
    RESPOND MSG="========================"

#####################################################################
#   Material-specific Settings
#####################################################################

[gcode_macro SAVE_MATERIAL_SETTINGS]
description: Speichere Material-spezifische Einstellungen
gcode:
    {% set material = params.MATERIAL|upper %}
    {% set pa = params.PA|default(0.035)|float %}
    {% set em = params.EM|default(1.0)|float %}

    SAVE_VARIABLE VARIABLE=pa_{material} VALUE={pa}
    SAVE_VARIABLE VARIABLE=em_{material} VALUE={em}
    RESPOND MSG="Saved {material}: PA={pa}, EM={em}"

[gcode_macro LOAD_MATERIAL_SETTINGS]
description: Lade Material-Einstellungen
gcode:
    {% set material = params.MATERIAL|upper %}
    {% set vars = printer.save_variables.variables %}

    {% set pa_var = "pa_" ~ material %}
    {% set em_var = "em_" ~ material %}

    {% if pa_var in vars %}
        SET_PRESSURE_ADVANCE ADVANCE={vars[pa_var]}
        RESPOND MSG="Loaded PA for {material}: {vars[pa_var]}"
    {% endif %}

    {% if em_var in vars %}
        M221 S{vars[em_var] * 100}
        RESPOND MSG="Loaded EM for {material}: {vars[em_var]}"
    {% endif %}
