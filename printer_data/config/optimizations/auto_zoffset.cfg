#####################################################################
#   Automatische Z-Offset Verwaltung
#   Verschiedene Build Plates & automatische Auswahl
#####################################################################

[gcode_macro SET_BUILD_PLATE]
description: Wähle Build Plate & lade Z-Offset
gcode:
    {% set plate = params.PLATE|default("smooth_pei")|lower %}

    # Speichere aktuelles Plate
    SAVE_VARIABLE VARIABLE=current_plate VALUE='"{plate}"'

    # Lade Z-Offset für dieses Plate
    LOAD_ZOFFSET PLATE={plate}

    # Material-spezifische Anpassungen
    {% if plate == "smooth_pei" %}
        RESPOND MSG="✓ Smooth PEI Sheet selected"
        # Smooth PEI: Standard Z-Offset
    {% elif plate == "textured_pei" %}
        RESPOND MSG="✓ Textured PEI Sheet selected"
        # Textured: +0.02mm typical
    {% elif plate == "spring_steel" %}
        RESPOND MSG="✓ Spring Steel Sheet selected"
    {% elif plate == "garolite" %}
        RESPOND MSG="✓ Garolite Sheet selected"
    {% elif plate == "glass" %}
        RESPOND MSG="✓ Glass Bed selected"
    {% endif %}

#####################################################################
#   Build Plate Quick Select
#####################################################################

[gcode_macro PLATE_SMOOTH_PEI]
description: Smooth PEI Sheet
gcode:
    SET_BUILD_PLATE PLATE=smooth_pei

[gcode_macro PLATE_TEXTURED_PEI]
description: Textured PEI Sheet
gcode:
    SET_BUILD_PLATE PLATE=textured_pei

[gcode_macro PLATE_SPRING_STEEL]
description: Spring Steel Sheet
gcode:
    SET_BUILD_PLATE PLATE=spring_steel

[gcode_macro PLATE_GAROLITE]
description: Garolite Sheet
gcode:
    SET_BUILD_PLATE PLATE=garolite

[gcode_macro PLATE_GLASS]
description: Glass Bed
gcode:
    SET_BUILD_PLATE PLATE=glass

#####################################################################
#   Z-Offset Calibration per Plate
#####################################################################

[gcode_macro CALIBRATE_PLATE_ZOFFSET]
description: Kalibriere Z-Offset für aktuelles Plate
gcode:
    {% set vars = printer.save_variables.variables %}
    {% set plate = vars.current_plate|default("smooth_pei") %}

    RESPOND MSG="=== Z-Offset Calibration ==="
    RESPOND MSG="Current Plate: {plate}"
    RESPOND MSG="1. Run PROBE_CALIBRATE"
    RESPOND MSG="2. Adjust Z with paper test"
    RESPOND MSG="3. Run ACCEPT"
    RESPOND MSG"4. Run SAVE_PLATE_ZOFFSET"
    RESPOND MSG="============================"

    # Start probe calibration
    PROBE_CALIBRATE

[gcode_macro SAVE_PLATE_ZOFFSET]
description: Speichere kalibrierten Z-Offset für aktuelles Plate
gcode:
    {% set vars = printer.save_variables.variables %}
    {% set plate = vars.current_plate|default("smooth_pei") %}
    {% set offset = printer.gcode_move.homing_origin.z %}

    SAVE_ZOFFSET PLATE={plate}
    RESPOND MSG="✓ Z-Offset saved for {plate}: {offset}mm"

#####################################################################
#   Auto Z-Offset Adjustment (in PRINT_START)
#####################################################################

[gcode_macro AUTO_ZOFFSET_ADJUSTMENT]
description: Automatische Z-Offset Anpassung basierend auf Material
gcode:
    {% set material = params.MATERIAL|default("PLA")|upper %}
    {% set vars = printer.save_variables.variables %}
    {% set plate = vars.current_plate|default("smooth_pei") %}

    # Basis Z-Offset vom aktuellen Plate
    LOAD_ZOFFSET PLATE={plate}

    # Material-spezifische Feinabstimmung
    {% set material_offset = 0.0 %}

    {% if material == "PETG" %}
        {% set material_offset = -0.01 %}  # PETG: etwas näher
    {% elif material == "ABS" or material == "ASA" %}
        {% set material_offset = 0.01 %}   # ABS: etwas weiter (wärmeausdehnung)
    {% elif material == "TPU" %}
        {% set material_offset = -0.02 %}  # TPU: näher für bessere Haftung
    {% endif %}

    # Apply material adjustment
    {% if material_offset != 0.0 %}
        SET_GCODE_OFFSET Z_ADJUST={material_offset} MOVE=1
        RESPOND MSG="Z-Offset adjusted for {material}: {material_offset|round(3)}mm"
    {% endif %}

#####################################################################
#   Live Z-Offset Adjustment
#####################################################################

[gcode_macro Z_UP]
description: Z-Offset +0.01mm (weiter weg)
gcode:
    SET_GCODE_OFFSET Z_ADJUST=0.01 MOVE=1
    RESPOND MSG="Z-Offset +0.01mm (away from bed)"
    _SHOW_CURRENT_ZOFFSET

[gcode_macro Z_DOWN]
description: Z-Offset -0.01mm (näher ran)
gcode:
    SET_GCODE_OFFSET Z_ADJUST=-0.01 MOVE=1
    RESPOND MSG="Z-Offset -0.01mm (closer to bed)"
    _SHOW_CURRENT_ZOFFSET

[gcode_macro Z_UP_FINE]
description: Z-Offset +0.005mm (fein)
gcode:
    SET_GCODE_OFFSET Z_ADJUST=0.005 MOVE=1
    RESPOND MSG="Z-Offset +0.005mm (fine)"
    _SHOW_CURRENT_ZOFFSET

[gcode_macro Z_DOWN_FINE]
description: Z-Offset -0.005mm (fein)
gcode:
    SET_GCODE_OFFSET Z_ADJUST=-0.005 MOVE=1
    RESPOND MSG="Z-Offset -0.005mm (fine)"
    _SHOW_CURRENT_ZOFFSET

[gcode_macro _SHOW_CURRENT_ZOFFSET]
gcode:
    {% set offset = printer.gcode_move.homing_origin.z %}
    RESPOND MSG="Current Z-Offset: {offset|round(3)}mm"

#####################################################################
#   First Layer Calibration Helper
#####################################################################

[gcode_macro FIRST_LAYER_CAL]
description: First Layer Kalibrierung (Single Square Test)
gcode:
    {% set bed_temp = params.BED|default(60)|int %}
    {% set extruder_temp = params.EXTRUDER|default(220)|int %}

    RESPOND MSG="Starting First Layer Calibration..."

    # Vorbereitung
    G28
    QUAD_GANTRY_LEVEL
    G28 Z
    BED_MESH_CALIBRATE ADAPTIVE=0

    # Aufheizen
    M190 S{bed_temp}
    M109 S{extruder_temp}

    # Fahre zu Center
    G90
    G0 X175 Y175 Z0.2 F9000

    # Purge etwas Filament
    G92 E0
    G1 E5 F300

    RESPOND MSG="Ready! Adjust Z with Z_UP/Z_DOWN"
    RESPOND MSG="Print 20x20mm square to test"

#####################################################################
#   Plate Info & Status
#####################################################################

[gcode_macro PLATE_INFO]
description: Zeige aktuelles Plate und Z-Offset
gcode:
    {% set vars = printer.save_variables.variables %}
    {% set plate = vars.current_plate|default("none") %}
    {% set offset = printer.gcode_move.homing_origin.z %}

    RESPOND MSG="=== Build Plate Info ==="
    RESPOND MSG="Current Plate: {plate}"
    RESPOND MSG="Current Z-Offset: {offset|round(3)}mm"

    # Zeige gespeicherte Z-Offsets
    RESPOND MSG="Saved Z-Offsets:"
    {% for name in vars %}
        {% if name.startswith("zoffset_") %}
            {% set plate_name = name.replace("zoffset_", "") %}
            RESPOND MSG="  {plate_name}: {vars[name]}mm"
        {% endif %}
    {% endfor %}
    RESPOND MSG="========================"
